# XojoAES

Sample code showing how to do AES256 (ECB only for now) in Xojo

See [blog post](http://kongduino.sungnyemun.org/2021/06/21/aes256-in-xojo/) for more info.

## C API

```c
void AES_init_ctx(struct AES_ctx* ctx, const uint8_t* key);
void AES_init_ctx_iv(struct AES_ctx* ctx, const uint8_t* key, const uint8_t* iv);
void AES_ctx_set_iv(struct AES_ctx* ctx, const uint8_t* iv);
int padLength(int originalLength);
void PKCS7(uint8_t* buf, int length, uint8_t b);
void AES_ECB_encrypt(const struct AES_ctx* ctx, uint8_t* buf);
void AES_ECB_decrypt(const struct AES_ctx* ctx, uint8_t* buf);
void AES_ECB_encrypt_buffer(const struct AES_ctx* ctx, uint8_t* buf, int length);
void AES_ECB_decrypt_buffer(const struct AES_ctx* ctx, uint8_t* buf, int length);
void AES_CBC_encrypt_buffer(struct AES_ctx* ctx, uint8_t* buf, uint32_t length);
void AES_CBC_decrypt_buffer(struct AES_ctx* ctx, uint8_t* buf, uint32_t length);
void AES_CTR_xcrypt_buffer(struct AES_ctx* ctx, uint8_t* buf, uint32_t length);
```

For `_buffer` functions you need to provide a buffer that's a multiple of `AES_BLOCKLEN`, ie 16, preferably properly padded. `padLength` and `PKCS7` can help with that.

## Python demo

### Basic code

```python
aes.AES_init_ctx(ctxB, keyB)
print("Key:")
hexDump(key)
print("Plaintext:")
hexDump(plainB[0:finalLength])
aes.AES_ECB_encrypt_buffer(ctxB, plainB, finalLength)
print("Encrypted:")
hexDump(plainB[0:finalLength])
aes.AES_ECB_decrypt_buffer(ctxB, plainB, finalLength)
print("Decrypted:")
hexDump(plainB[0:finalLength])
```


```
% make test
python3 test.py 


ECB
=====
 • Key:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|59 45 4c 4c 4f 57 20 53 55 42 4d 41 52 49 4e 45 | |YELLOW SUBMARINE|
01.|45 4e 49 52 41 4d 42 55 53 20 57 4f 4c 4c 45 59 | |ENIRAMBUS WOLLEY|
   +------------------------------------------------+ +----------------+
 • Plaintext:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+
 • Encrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|9d 41 b3 a3 65 9a 55 0a 0a 54 67 5d 59 ff 69 00 | |.A..e.U..Tg]Y.i.|
01.|33 a8 24 07 bb 63 a4 99 70 ac 4f 9d cc 09 88 95 | |3.$..c..p.O.....|
02.|b1 65 e8 ee ce ed 22 23 43 b6 6a 26 b7 26 65 47 | |.e...."#C.j&.&eG|
   +------------------------------------------------+ +----------------+
 • Decrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+
 • Encrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|9d 41 b3 a3 65 9a 55 0a 0a 54 67 5d 59 ff 69 00 | |.A..e.U..Tg]Y.i.|
01.|33 a8 24 07 bb 63 a4 99 70 ac 4f 9d cc 09 88 95 | |3.$..c..p.O.....|
02.|b1 65 e8 ee ce ed 22 23 43 b6 6a 26 b7 26 65 47 | |.e...."#C.j&.&eG|
   +------------------------------------------------+ +----------------+
 • Decrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+


CBC
=====
 • Plaintext:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+
 • IV:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff | |................|
   +------------------------------------------------+ +----------------+
 • Encrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|39 94 57 b2 cd 30 2d e3 6d 24 54 64 96 0d 55 55 | |9.W..0-.m$Td..UU|
01.|3c aa f2 0f bf e5 63 18 6b 68 f6 f6 9e 3e 82 51 | |<.....c.kh...>.Q|
02.|68 0b dc c9 d2 7a e8 90 f2 22 b7 8e 03 06 44 c0 | |h....z..."....D.|
   +------------------------------------------------+ +----------------+
 • Decrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+

 • IV:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff | |................|
   +------------------------------------------------+ +----------------+
 • Encrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|39 94 57 b2 cd 30 2d e3 6d 24 54 64 96 0d 55 55 | |9.W..0-.m$Td..UU|
01.|3c aa f2 0f bf e5 63 18 6b 68 f6 f6 9e 3e 82 51 | |<.....c.kh...>.Q|
02.|68 0b dc c9 d2 7a e8 90 f2 22 b7 8e 03 06 44 c0 | |h....z..."....D.|
   +------------------------------------------------+ +----------------+
 • Decrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+


CTR
=====
 • Plaintext:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+

 • IV:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff | |................|
   +------------------------------------------------+ +----------------+
 • Encrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|3a 18 28 bd 10 34 24 dc f6 af 3f 93 cb ea 52 d4 | |:.(..4$...?...R.|
01.|38 ef 6b 37 25 71 e1 78 d7 ef fe 8f 17 dc f3 5e | |8.k7%q.x.......^|
02.|3f 7b 21 df 34 ab 17 ff 18 f1 ee 48 58 7c f9 81 | |?{!.4......HX|..|
   +------------------------------------------------+ +----------------+
 • Decrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+

 • IV:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff | |................|
   +------------------------------------------------+ +----------------+
 • Encrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|3a 18 28 bd 10 34 24 dc f6 af 3f 93 cb ea 52 d4 | |:.(..4$...?...R.|
01.|38 ef 6b 37 25 71 e1 78 d7 ef fe 8f 17 dc f3 5e | |8.k7%q.x.......^|
02.|3f 7b 21 df 34 ab 17 ff 18 f1 ee 48 58 7c f9 81 | |?{!.4......HX|..|
   +------------------------------------------------+ +----------------+
 • Decrypted:
   +------------------------------------------------+ +----------------+
   |.0 .1 .2 .3 .4 .5 .6 .7 .8 .9 .a .b .c .d .e .f | |      ASCII     |
   +------------------------------------------------+ +----------------+
00.|48 65 79 20 77 68 61 73 73 75 70 3f 20 54 68 69 | |Hey whassup? Thi|
01.|73 20 69 73 20 61 6e 20 75 6e 70 61 64 64 65 64 | |s is an unpadded|
02.|20 73 74 72 69 6e 67 21 08 08 08 08 08 08 08 08 | | string!........|
   +------------------------------------------------+ +----------------+
See? With CBC/CTR the cipher is different every time.
```

# Don't use ECB though...

As you can see, the cipher with ECB is always the same, whereas with CBC and CTR it changes every time, preventing the [easier attacks on the cipher](https://cryptopals.com/sets/2).

### fillRandom

I added a von Neumann extractor to improve randomness.

